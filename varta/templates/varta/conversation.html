<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Varta - Live Conversation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Add CSRF token and user data from Django -->
    <script>
        const CSRF_TOKEN = "{{ csrf_token }}";
        const USER_DATA = {{ user_data|safe }};
        const INITIAL_MESSAGES = {{ messages_data|safe }};
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9',
                            600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#fdf4ff', 100: '#fae8ff', 500: '#d946ef',
                            600: '#c026d3', 700: '#a21caf',
                        },
                        accent: {
                            50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse-ring { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .dashboard-transition { transition: all 0.3s ease; }
        .active-dashboard-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .message-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .floating-action { box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <div class="w-80 dashboard-card flex flex-col m-4 dashboard-transition">
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-comments text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold gradient-text">Varta</h1>
                    <p class="text-gray-500 text-sm">Connect through conversation</p>
                </div>
            </div>
            
            <div class="mt-6 space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Translate From</span>
                </div>
                <select id="source-language" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="bn">Bengali</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="mr">Marathi</option>
                    <option value="gu">Gujarati</option>
                    <option value="kn">Kannada</option>
                    <option value="ml">Malayalam</option>
                    <option value="pa">Punjabi</option>
                </select>
                
                <div class="flex justify-center">
                    <i class="fas fa-exchange-alt text-gray-400 text-sm"></i>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">Translate To</span>
                </div>
                <select id="target-language" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    <option value="hi">Hindi</option>
                    <option value="en">English</option>
                    <option value="bn">Bengali</option>
                    <option value="ta">Tamil</option>
                    <option value="te">Telugu</option>
                    <option value="mr">Marathi</option>
                    <option value="gu">Gujarati</option>
                    <option value="kn">Kannada</option>
                    <option value="ml">Malayalam</option>
                    <option value="pa">Punjabi</option>
                </select>
            </div>
        </div>
        
        <div class="flex-1 py-4">
            <div class="space-y-2 px-4">
                <div class="dashboard-item active-dashboard-item rounded-xl p-4" data-page="conversation">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white/80 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-comment-dots text-primary-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold">Live Conversation</h3>
                            <p class="text-sm opacity-80">Real-time chat & translation</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-item rounded-xl p-4 hover:bg-gray-50 cursor-pointer" data-page="quick-responses">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white/80 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-reply text-secondary-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Quick Responses</h3>
                            <p class="text-sm text-gray-600">Frequently used phrases</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-item rounded-xl p-4 hover:bg-gray-50 cursor-pointer" data-page="emergency">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white/80 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-ambulance text-red-500"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Emergency Contacts</h3>
                            <p class="text-sm text-gray-600">Important numbers</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-item rounded-xl p-4 hover:bg-gray-50 cursor-pointer" data-page="history">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white/80 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-history text-purple-500"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Conversation History</h3>
                            <p class="text-sm text-gray-600">Past conversations</p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-item rounded-xl p-4 hover:bg-gray-50 cursor-pointer" data-page="settings">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-white/80 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-cog text-gray-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">Settings</h3>
                            <p class="text-sm text-gray-600">Customize your experience</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 px-4">
                <h3 class="font-semibold text-gray-800 mb-3">Today's Activity</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-primary-50 rounded-xl p-3">
                        <p class="text-xs text-primary-700">Conversations</p>
                        <p class="text-lg font-bold text-primary-800">12</p>
                    </div>
                    <div class="bg-accent-50 rounded-xl p-3">
                        <p class="text-xs text-accent-700">Messages</p>
                        <p class="text-lg font-bold text-accent-800">47</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Section without Logout -->
        <div class="p-4 border-t border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                    <span class="text-white font-semibold" id="user-initials">AK</span>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-gray-800" id="user-name">Aarav Kumar</p>
                    <p class="text-gray-500 text-sm">Online</p>
                </div>
                <div class="relative">
                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col m-4 mr-0 overflow-hidden">
        <div class="dashboard-card p-6 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="page-title" class="text-3xl font-bold text-gray-900">Live Conversation</h1>
                    <p id="page-subtitle" class="text-gray-600">Real-time speech to text communication with translation</p>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-primary-50 rounded-xl px-4 py-2">
                        <i class="fas fa-globe text-primary-600"></i>
                        <span id="translation-status" class="text-primary-700 font-medium">English → Hindi</span>
                    </div>
                    
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl flex items-center shadow">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-hidden flex gap-4">
            <!-- Main Content Pages -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Conversation Page -->
                <div id="conversation-page" class="dashboard-page active h-full flex flex-col">
                    <div class="dashboard-card flex-1 flex flex-col overflow-hidden">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center">
                                        <span class="text-white font-semibold text-lg">AI</span>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-xl text-gray-800">AI BOT</h3>
                                        <p class="text-gray-600">Online • Translating: <span id="current-translation">Hindi to English</span></p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button id="speaker-btn" class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center hover:bg-gray-50">
                                        <i class="fas fa-volume-up text-gray-600"></i>
                                    </button>
                                    <button class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center hover:bg-gray-50">
                                        <i class="fas fa-video text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 p-6 overflow-y-auto scrollbar-thin" id="messages-container">
                            <div class="text-center text-gray-500 py-10">
                                <i class="fas fa-comments text-5xl mb-4 text-gray-300"></i>
                                <p class="text-xl">Start a conversation by typing or using voice</p>
                                <p class="text-gray-400 mt-2">Your messages will be translated in real-time</p>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-100 p-6">
                            <div class="space-y-4">
                                <div id="transcription-status" class="hidden">
                                    <div class="flex items-center gap-3 bg-primary-50 border border-primary-200 rounded-xl p-3">
                                        <div class="flex items-center gap-2">
                                            <div id="listening-indicator" class="w-3 h-3 bg-red-500 rounded-full"></div>
                                            <span id="current-speaker" class="font-medium text-primary-800">You</span>
                                        </div>
                                        <div class="flex-1">
                                            <p id="current-transcript" class="text-primary-700"></p>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-3">
                                    <textarea
                                        id="text-input"
                                        placeholder="Type your message here..."
                                        class="flex-1 min-h-[80px] text-lg resize-none px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    ></textarea>
                                    <div class="flex flex-col gap-2">
                                        <button
                                            id="send-text"
                                            class="gradient-bg hover:opacity-90 text-white p-4 rounded-xl flex items-center justify-center transition-all shadow-lg"
                                        >
                                            <i class="fas fa-paper-plane text-lg"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="flex flex-wrap items-center justify-between gap-4">
                                    <div class="flex items-center gap-3">
                                        <button
                                            id="toggle-listening"
                                            class="bg-accent-500 hover:bg-accent-600 text-white px-5 py-3 rounded-xl flex items-center shadow-lg transition-colors floating-action"
                                        >
                                            <i class="fas fa-microphone mr-2"></i>
                                            Start Listening
                                        </button>

                                        <button
                                            id="toggle-audio"
                                            class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-5 py-3 rounded-xl flex items-center transition-colors"
                                        >
                                            <i class="fas fa-volume-up mr-2"></i>
                                            Audio On
                                        </button>
                                    </div>

                                    <button
                                        id="toggle-quick-responses"
                                        class="bg-secondary-50 border border-secondary-200 text-secondary-700 hover:bg-secondary-100 px-5 py-3 rounded-xl flex items-center transition-colors"
                                    >
                                        <i class="fas fa-bolt mr-2"></i>
                                        Quick Responses
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Responses Page -->
                <div id="quick-responses-page" class="dashboard-page hidden h-full">
                    <div class="dashboard-card h-full flex flex-col">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Quick Responses</h2>
                                    <p class="text-gray-600">Manage your frequently used responses</p>
                                </div>
                                <button id="add-quick-response" class="gradient-bg hover:opacity-90 text-white px-4 py-2 rounded-xl flex items-center shadow-lg">
                                    <i class="fas fa-plus mr-2"></i>
                                    Add New Response
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-1 p-6 overflow-y-auto">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="quick-responses-grid">
                                <!-- Quick responses will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Page -->
                <div id="emergency-page" class="dashboard-page hidden h-full">
                    <div class="dashboard-card h-full flex flex-col">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Emergency Contacts</h2>
                                    <p class="text-gray-600">Important contacts for emergency situations</p>
                                </div>
                                <button id="add-emergency-contact" class="gradient-bg hover:opacity-90 text-white px-4 py-2 rounded-xl flex items-center shadow-lg">
                                    <i class="fas fa-plus mr-2"></i>
                                    Add Contact
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-1 p-6 overflow-y-auto">
                            <div class="space-y-4" id="emergency-contacts-list">
                                <!-- Emergency contacts will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- History Page -->
                <div id="history-page" class="dashboard-page hidden h-full">
                    <div class="dashboard-card h-full flex flex-col">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Conversation History</h2>
                                    <p class="text-gray-600">Review your past conversations</p>
                                </div>
                                <div class="flex gap-2">
                                    <button id="filter-history" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition flex items-center">
                                        <i class="fas fa-filter mr-2"></i>Filter
                                    </button>
                                    <button id="search-history" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition flex items-center">
                                        <i class="fas fa-search mr-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 p-6 overflow-y-auto">
                            <div class="space-y-4" id="conversation-history-list">
                                <!-- Conversation history will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Page -->
                <div id="settings-page" class="dashboard-page hidden h-full flex flex-col overflow-y-auto">
                    <div class="dashboard-card flex-1 flex flex-col">
                        <div class="p-6 border-b border-gray-100">
                            <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
                            <p class="text-gray-600">Customize your Varta experience</p>
                        </div>

                        <div class="p-6 space-y-8 flex-1 overflow-y-auto">
                            <!-- Profile Settings -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">Profile Settings</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input type="text" id="profile-name" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" value="Aarav Kumar">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="profile-email" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" value="aarav.kumar@example.com">
                                    </div>
                                </div>
                                <button id="update-profile" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 shadow">Update Profile</button>
                            </div>

                            <!-- Language Settings -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">Language Settings</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Source Language</label>
                                        <select id="settings-source-language" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                            <option value="en">English</option>
                                            <option value="hi">Hindi</option>
                                            <option value="bn">Bengali</option>
                                            <option value="ta">Tamil</option>
                                            <option value="te">Telugu</option>
                                            <option value="mr">Marathi</option>
                                            <option value="gu">Gujarati</option>
                                            <option value="kn">Kannada</option>
                                            <option value="ml">Malayalam</option>
                                            <option value="pa">Punjabi</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Language</label>
                                        <select id="settings-target-language" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                            <option value="en">English</option>
                                            <option value="hi">Hindi</option>
                                            <option value="bn">Bengali</option>
                                            <option value="ta">Tamil</option>
                                            <option value="te">Telugu</option>
                                            <option value="mr">Marathi</option>
                                            <option value="gu">Gujarati</option>
                                            <option value="kn">Kannada</option>
                                            <option value="ml">Malayalam</option>
                                            <option value="pa">Punjabi</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Speech Settings -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">Speech Settings</h3>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="toggle-auto-speak" class="h-5 w-5 accent-primary-500" checked>
                                        <span class="text-gray-700">Auto Speak Translations</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <span class="text-gray-700">Speech Rate:</span>
                                        <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1" class="w-48">
                                        <span id="speech-rate-value" class="text-sm text-gray-600">1.0</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Display Settings -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">Display Settings</h3>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="toggle-show-original" class="h-5 w-5 accent-primary-500" checked>
                                        <span class="text-gray-700">Show Original + Translated Text</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-4">
                                    <label class="block text-gray-700">Font Size</label>
                                    <select id="font-size" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                        <option value="text-sm">Small</option>
                                        <option value="text-base" selected>Medium</option>
                                        <option value="text-lg">Large</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">Notifications</h3>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="toggle-message-alerts" class="h-5 w-5 accent-primary-500" checked>
                                        <span class="text-gray-700">Message Alerts</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="toggle-speech-alerts" class="h-5 w-5 accent-primary-500" checked>
                                        <span class="text-gray-700">Speech Alerts</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Privacy -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">Privacy & Security</h3>
                                <div class="flex gap-2">
                                    <button id="clear-history" class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 shadow">Clear Chat History</button>
                                    <button id="export-data" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600 shadow">Export Data</button>
                                </div>
                            </div>

                            <!-- About -->
                            <div class="space-y-3">
                                <h3 class="font-semibold text-gray-800">About</h3>
                                <p class="text-gray-600">Varta - Real-time multilingual conversation app.</p>
                                <p class="text-gray-500 text-sm">Version 1.0.0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Responses Panel -->
            <div id="quick-responses-panel" class="hidden w-80 dashboard-card overflow-hidden flex-col slide-in-right">
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-gray-800">Quick Responses</h2>
                        <button id="close-quick-responses" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-1 p-4 overflow-y-auto scrollbar-thin" id="quick-responses-list">
                    <!-- Quick responses will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden audio element for text-to-speech -->
    <audio id="tts-audio" hidden></audio>

    <!-- Modals -->
    <!-- Add Quick Response Modal -->
    <div id="add-response-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="dashboard-card w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900">Add Quick Response</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Response Text</label>
                    <textarea id="new-response-text" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" rows="3" placeholder="Enter your quick response..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="new-response-category" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="Greetings">Greetings</option>
                        <option value="Gratitude">Gratitude</option>
                        <option value="Clarification">Clarification</option>
                        <option value="Agreement">Agreement</option>
                        <option value="Emergency">Emergency</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                <button id="cancel-add-response" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-response" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">Save Response</button>
            </div>
        </div>
    </div>

    <!-- Add Emergency Contact Modal -->
    <div id="add-contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="dashboard-card w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900">Add Emergency Contact</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
                    <input type="text" id="new-contact-name" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Enter contact name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="text" id="new-contact-phone" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" placeholder="Enter phone number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="new-contact-type" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                        <option value="Emergency Services">Emergency Services</option>
                        <option value="Medical">Medical</option>
                        <option value="Police">Police</option>
                        <option value="Fire Department">Fire Department</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                <button id="cancel-add-contact" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="save-contact" class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">Save Contact</button>
            </div>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logout-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="dashboard-card w-full max-w-md mx-4">
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-900">Logout</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700">Are you sure you want to logout?</p>
            </div>
            <div class="p-6 border-t border-gray-100 flex justify-end gap-3">
                <button id="cancel-logout" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirm-logout" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Logout</button>
            </div>
        </div>
    </div>

<script>
    // State management - Updated with real user data
    const state = {
        isListening: false,
        currentTranscript: "",
        messages: INITIAL_MESSAGES || [],
        textInput: "",
        speakingEnabled: true,
        participants: ["You"],
        currentSpeaker: "You",
        showQuickResponses: false,
        conversationTitle: "",
        isRecognitionSupported: false,
        sourceLanguage: "en",
        targetLanguage: "hi",
        user: USER_DATA || {
            id: 1,
            name: "Aarav Kumar",
            email: "aarav.kumar@example.com",
            language: 'en-US',
            accessibility_settings: {
                auto_speak: true,
                speech_rate: 1.0
            }
        },
        quickResponses: [
            { id: 1, text: "Hello, how are you?", frequency_used: 12, category: "Greetings" },
            { id: 2, text: "Thank you for your help.", frequency_used: 8, category: "Gratitude" },
            { id: 3, text: "I'm sorry, I didn't understand that.", frequency_used: 5, category: "Clarification" },
            { id: 4, text: "Could you please repeat that?", frequency_used: 7, category: "Clarification" },
            { id: 5, text: "Yes, I agree.", frequency_used: 6, category: "Agreement" },
            { id: 6, text: "I need medical assistance.", frequency_used: 3, category: "Emergency" },
        ],
        emergencyContacts: [
            { id: 1, name: "Emergency Services", phone: "112", type: "Emergency Services" },
            { id: 2, name: "Medical Emergency", phone: "108", type: "Medical" },
            { id: 3, name: "Police", phone: "100", type: "Police" },
            { id: 4, name: "Fire Department", phone: "101", type: "Fire Department" },
            { id: 5, name: "Aarav Kumar (Brother)", phone: "+91 98765 43210", type: "Personal" },
        ],
        conversationHistory: [
            { id: 1, contact: "Sunita Kapoor", languagePair: "English → Hindi", messageCount: 12, lastMessage: "Hello, how are you? I need some help with...", timestamp: "2 hours ago" },
            { id: 2, contact: "Rajesh Kumar", languagePair: "Hindi → English", messageCount: 8, lastMessage: "Thank you for your assistance yesterday...", timestamp: "5 hours ago" },
            { id: 3, contact: "Priya Mehta", languagePair: "Tamil → English", messageCount: 15, lastMessage: "Can you help me find the nearest hospital?", timestamp: "Yesterday" },
            { id: 4, contact: "Anil Sharma", languagePair: "Bengali → Hindi", messageCount: 6, lastMessage: "Where is the nearest pharmacy?", timestamp: "2 days ago" },
        ],
        currentPage: 'conversation',
        settings: {
            autoSpeak: true,
            speechRate: 1.0,
            showOriginal: true,
            fontSize: 'text-base',
            messageAlerts: true,
            speechAlerts: true,
            sourceLanguage: 'en',
            targetLanguage: 'hi'
        }
    };

    // Language mapping
    const languageMap = {
        'en': 'English', 'hi': 'Hindi', 'bn': 'Bengali', 'ta': 'Tamil', 'te': 'Telugu',
        'mr': 'Marathi', 'gu': 'Gujarati', 'kn': 'Kannada', 'ml': 'Malayalam', 'pa': 'Punjabi'
    };
    
    // BCP 47 language codes map for Speech APIs
    const languageCodeMap = {
        'en': 'en-US', 'hi': 'hi-IN', 'bn': 'bn-IN', 'ta': 'ta-IN', 'te': 'te-IN',
        'mr': 'mr-IN', 'gu': 'gu-IN', 'kn': 'kn-IN', 'ml': 'ml-IN', 'pa': 'pa-IN'
    };

    // DOM Elements
    const elements = {
        // Main elements
        messagesContainer: document.getElementById('messages-container'),
        textInput: document.getElementById('text-input'),
        sendText: document.getElementById('send-text'),
        toggleListening: document.getElementById('toggle-listening'),
        toggleAudio: document.getElementById('toggle-audio'),
        toggleQuickResponses: document.getElementById('toggle-quick-responses'),
        quickResponsesPanel: document.getElementById('quick-responses-panel'),
        closeQuickResponses: document.getElementById('close-quick-responses'),
        quickResponsesList: document.getElementById('quick-responses-list'),
        quickResponsesGrid: document.getElementById('quick-responses-grid'),
        transcriptionStatus: document.getElementById('transcription-status'),
        currentTranscript: document.getElementById('current-transcript'),
        currentSpeaker: document.getElementById('current-speaker'),
        listeningIndicator: document.getElementById('listening-indicator'),
        pageTitle: document.getElementById('page-title'),
        pageSubtitle: document.getElementById('page-subtitle'),
        dashboardItems: document.querySelectorAll('.dashboard-item'),
        dashboardPages: document.querySelectorAll('.dashboard-page'),
        sourceLanguage: document.getElementById('source-language'),
        targetLanguage: document.getElementById('target-language'),
        translationStatus: document.getElementById('translation-status'),
        currentTranslation: document.getElementById('current-translation'),
        
        // Profile elements
        userName: document.getElementById('user-name'),
        userInitials: document.getElementById('user-initials'),
        
        // Logout elements
        logoutBtn: document.getElementById('logout-btn'),
        logoutModal: document.getElementById('logout-modal'),
        cancelLogout: document.getElementById('cancel-logout'),
        confirmLogout: document.getElementById('confirm-logout'),
        
        // Settings elements
        profileName: document.getElementById('profile-name'),
        profileEmail: document.getElementById('profile-email'),
        updateProfile: document.getElementById('update-profile'),
        settingsAutoSpeak: document.getElementById('toggle-auto-speak'),
        settingsSpeechRate: document.getElementById('speech-rate'),
        speechRateValue: document.getElementById('speech-rate-value'),
        settingsShowOriginal: document.getElementById('toggle-show-original'),
        settingsFontSize: document.getElementById('font-size'),
        settingsMessageAlerts: document.getElementById('toggle-message-alerts'),
        settingsSpeechAlerts: document.getElementById('toggle-speech-alerts'),
        settingsSourceLanguage: document.getElementById('settings-source-language'),
        settingsTargetLanguage: document.getElementById('settings-target-language'),
        settingsClearHistory: document.getElementById('clear-history'),
        exportData: document.getElementById('export-data'),
        
        // Speaker button
        speakerBtn: document.getElementById('speaker-btn'),
        
        // TTS Audio element
        ttsAudio: document.getElementById('tts-audio'),
        
        // Quick Responses elements
        addQuickResponse: document.getElementById('add-quick-response'),
        addResponseModal: document.getElementById('add-response-modal'),
        cancelAddResponse: document.getElementById('cancel-add-response'),
        saveResponse: document.getElementById('save-response'),
        newResponseText: document.getElementById('new-response-text'),
        newResponseCategory: document.getElementById('new-response-category'),
        
        // Emergency Contacts elements
        addEmergencyContact: document.getElementById('add-emergency-contact'),
        addContactModal: document.getElementById('add-contact-modal'),
        cancelAddContact: document.getElementById('cancel-add-contact'),
        saveContact: document.getElementById('save-contact'),
        newContactName: document.getElementById('new-contact-name'),
        newContactPhone: document.getElementById('new-contact-phone'),
        newContactType: document.getElementById('new-contact-type'),
        emergencyContactsList: document.getElementById('emergency-contacts-list'),
        
        // History elements
        filterHistory: document.getElementById('filter-history'),
        searchHistory: document.getElementById('search-history'),
        conversationHistoryList: document.getElementById('conversation-history-list')
    };

    // ============================
    // DJANGO BACKEND INTEGRATION
    // ============================

    // CSRF helper function for AJAX requests
    function getCSRFToken() {
        return CSRF_TOKEN;
    }

    // Real translation using Django backend
    async function translateText(text, targetLang) {
        try {
            const response = await fetch(`/translate-text/?text=${encodeURIComponent(text)}&target=${targetLang}`, {
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });
            if (!response.ok) {
                throw new Error('Translation failed');
            }
            const data = await response.json();
            return {
                translatedText: data.translated_text,
                sourceLang: data.source_lang
            };
        } catch (error) {
            console.error('Translation error:', error);
            // Fallback to simulated translation
            return {
                translatedText: simulateTranslation(text, state.sourceLanguage, targetLang),
                sourceLang: state.sourceLanguage
            };
        }
    }

    // Real text-to-speech using Django backend
    async function textToSpeech(text, lang) {
        if (!state.speakingEnabled) return;
        
        try {
            const response = await fetch(`/text-to-speech/?text=${encodeURIComponent(text)}&lang=${lang}`);
            if (!response.ok) {
                throw new Error('TTS failed');
            }
            
            // Create blob from response and play it
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            
            elements.ttsAudio.src = audioUrl;
            elements.ttsAudio.play().catch(e => console.error('Audio play failed:', e));
            
        } catch (error) {
            console.error('TTS error:', error);
            // Fallback to browser TTS
            speakText(text, lang);
        }
    }

    // Enhanced addMessage function that saves to database
    async function addMessage(message) {
        // If no translation provided, get real translation
        if (!message.translatedMessage && message.speaker === "You") {
            const translation = await translateText(message.message, state.targetLanguage);
            message.translatedMessage = translation.translatedText;
            message.sourceLanguage = translation.sourceLang;
        }
        
        // Save to database via AJAX
        try {
            const response = await fetch('/save-conversation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    message: message.message,
                    translated_message: message.translatedMessage,
                    source_language: message.sourceLanguage || state.sourceLanguage,
                    target_language: state.targetLanguage,
                    type: message.type || 'text'
                })
            });
            
            const result = await response.json();
            if (result.success) {
                message.id = result.id;
                message.timestamp = result.timestamp;
            }
        } catch (error) {
            console.error('Error saving message:', error);
        }
        
        state.messages.unshift({ ...message, id: message.id || Date.now() });
        renderMessages();
        
        // Use real TTS
        if (state.speakingEnabled && message.translatedMessage) {
            const textToSpeak = message.speaker === "You" ? message.translatedMessage : message.message;
            const langToSpeak = message.speaker === "You" ? state.targetLanguage : (message.sourceLanguage || state.sourceLanguage);
            await textToSpeech(textToSpeak, langToSpeak);
        }
    }

    // ============================
    // SPEECH RECOGNITION & TTS
    // ============================

    let recognition = null;
    
    function initializeSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            state.isRecognitionSupported = false;
            elements.toggleListening.disabled = true;
            elements.toggleListening.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>Not Supported';
            elements.toggleListening.classList.add('opacity-50', 'cursor-not-allowed');
            return;
        }
        
        state.isRecognitionSupported = true;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = languageCodeMap[state.sourceLanguage] || 'en-US';
        
        recognition.onstart = () => {
            state.isListening = true;
            updateListeningUI();
            showNotification('Speech recognition started');
        };
        
        recognition.onend = () => {
            if (state.isListening) {
                try {
                   recognition.start();
                } catch (e) {
                   console.error("Recognition restart failed", e);
                   state.isListening = false;
                   updateListeningUI();
                }
            } else {
                state.isListening = false;
                updateListeningUI();
            }
        };
        
        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            state.isListening = false;
            updateListeningUI();
            showNotification('Speech recognition error: ' + event.error);
        };
        
        recognition.onresult = async (event) => {
            let finalTranscript = '';
            let interimTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }

            if (finalTranscript.trim()) {
                // Use real translation API
                const translation = await translateText(finalTranscript, state.targetLanguage);
                
                addMessage({
                    speaker: state.currentSpeaker,
                    message: finalTranscript,
                    translatedMessage: translation.translatedText,
                    sourceLanguage: translation.sourceLang,
                    type: "speech",
                    timestamp: new Date().toISOString()
                });
                state.currentTranscript = "";
                updateTranscriptionUI();
            } else {
                state.currentTranscript = interimTranscript;
                updateTranscriptionUI();
            }
        };
    }

    // Browser fallback TTS
    function speakText(text, lang) {
        if (!state.speakingEnabled || !('speechSynthesis' in window)) return;
        
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        
        const voices = window.speechSynthesis.getVoices();
        const voice = voices.find(v => v.lang === lang || v.lang.startsWith(lang.split('-')[0]));
        if (voice) {
            utterance.voice = voice;
        }
        
        utterance.rate = state.user.accessibility_settings.speech_rate || 1.0;
        window.speechSynthesis.speak(utterance);
    }

    // Simulated translation fallback
    function simulateTranslation(text, sourceLang, targetLang) {
        const translations = {
            'en-hi': {
                'hello how are you': 'नमस्ते, आप कैसे हैं?',
                'thank you for your help': 'आपकी मदद के लिए धन्यवाद।',
                'i need assistance': 'मुझे सहायता चाहिए।',
                'where is the hospital': 'अस्पताल कहाँ है?',
                'i do not understand': 'मैं समझा नहीं।',
                'i need medical help': 'मुझे चिकित्सा सहायता चाहिए।',
                'call an ambulance': 'एम्बुलेंस बुलाओ।',
                'where is the police station': 'पुलिस स्टेशन कहाँ है?'
            },
            'hi-en': {
                'नमस्ते आप कैसे हैं': 'Hello, how are you?',
                'आपकी मदद के लिए धन्यवाद': 'Thank you for your help.',
                'मुझे सहायता चाहिए': 'I need assistance.',
                'मुझे चिकित्सा सहायता चाहिए': 'I need medical help.',
                'एम्बुलेंस बुलाओ': 'Call an ambulance.',
                'पुलिस स्टेशन कहाँ है': 'Where is the police station?'
            }
        };
        
        const key = `${sourceLang}-${targetLang}`;
        const lookupText = text.trim().toLowerCase().replace(/[.,?]/g, '');
        return translations[key]?.[lookupText] || `[Translated: ${text}]`;
    }

    // ============================
    // CORE APPLICATION FUNCTIONS
    // ============================

    function updateConversationHistory(message) {
        const existingConversation = state.conversationHistory.find(c => c.contact === "Sunita Kapoor");
        if (existingConversation) {
            existingConversation.lastMessage = message.message.length > 50 
                ? message.message.substring(0, 50) + '...' 
                : message.message;
            existingConversation.messageCount += 1;
            existingConversation.timestamp = 'Just now';
        }
    }

    async function sendTextMessage() {
        const text = elements.textInput.value.trim();
        if (!text) return;
        
        await addMessage({
            speaker: "You", 
            message: text, 
            type: "text",
            timestamp: new Date().toISOString()
        });
        
        elements.textInput.value = "";
    }

    function toggleListening() {
        if (!recognition) return;
        
        if (state.isListening) {
            state.isListening = false;
            recognition.stop();
            showNotification('Speech recognition stopped');
        } else {
            try {
                recognition.start();
            } catch (err) {
                console.error("Error starting speech recognition:", err);
                showNotification('Error starting speech recognition');
            }
        }
    }

    function toggleAudio() {
        state.speakingEnabled = !state.speakingEnabled;
        updateAudioUI();
        if (!state.speakingEnabled) {
            window.speechSynthesis.cancel();
            elements.ttsAudio.pause();
        }
        showNotification(`Audio ${state.speakingEnabled ? 'enabled' : 'disabled'}`);
    }

    function toggleQuickResponses() {
        state.showQuickResponses = !state.showQuickResponses;
        updateQuickResponsesUI();
    }

    // UI Update Functions
    function updateListeningUI() {
        if (state.isListening) {
            elements.toggleListening.innerHTML = '<i class="fas fa-microphone-slash mr-2"></i>Stop Listening';
            elements.toggleListening.classList.remove('bg-accent-500', 'hover:bg-accent-600');
            elements.toggleListening.classList.add('bg-red-500', 'hover:bg-red-600');
            elements.listeningIndicator.classList.remove('bg-red-500');
            elements.listeningIndicator.classList.add('bg-green-500', 'pulse-ring');
        } else {
            elements.toggleListening.innerHTML = '<i class="fas fa-microphone mr-2"></i>Start Listening';
            elements.toggleListening.classList.remove('bg-red-500', 'hover:bg-red-600');
            elements.toggleListening.classList.add('bg-accent-500', 'hover:bg-accent-600');
            elements.listeningIndicator.classList.remove('bg-green-500', 'pulse-ring');
            elements.listeningIndicator.classList.add('bg-red-500');
            state.currentTranscript = "";
            updateTranscriptionUI();
        }
    }

    function updateAudioUI() {
        if (state.speakingEnabled) {
            elements.toggleAudio.innerHTML = '<i class="fas fa-volume-up mr-2"></i>Audio On';
            elements.toggleAudio.classList.add('border-primary-300', 'text-primary-700', 'bg-primary-50');
            elements.toggleAudio.classList.remove('border-gray-300', 'text-gray-700');
        } else {
            elements.toggleAudio.innerHTML = '<i class="fas fa-volume-mute mr-2"></i>Audio Off';
            elements.toggleAudio.classList.remove('border-primary-300', 'text-primary-700', 'bg-primary-50');
            elements.toggleAudio.classList.add('border-gray-300', 'text-gray-700');
        }
    }

    function updateTranscriptionUI() {
        if (state.isListening && state.currentTranscript) {
            elements.transcriptionStatus.classList.remove('hidden');
            elements.currentTranscript.textContent = state.currentTranscript;
        } else {
            elements.transcriptionStatus.classList.add('hidden');
        }
    }

    function updateQuickResponsesUI() {
        if (state.showQuickResponses) {
            elements.quickResponsesPanel.classList.remove('hidden');
            elements.quickResponsesPanel.classList.add('flex');
        } else {
            elements.quickResponsesPanel.classList.add('hidden');
            elements.quickResponsesPanel.classList.remove('flex');
        }
    }

    function updateTranslationUI() {
        const sourceLangName = languageMap[state.sourceLanguage];
        const targetLangName = languageMap[state.targetLanguage];
        elements.translationStatus.textContent = `${sourceLangName} → ${targetLangName}`;
        elements.currentTranslation.textContent = `${sourceLangName} to ${targetLangName}`;
    }

    function updatePageUI() {
        const pageInfo = {
            'conversation': { title: 'Live Conversation', subtitle: 'Real-time speech to text communication' },
            'quick-responses': { title: 'Quick Responses', subtitle: 'Manage your frequently used responses' },
            'emergency': { title: 'Emergency Contacts', subtitle: 'Important contacts for emergency situations' },
            'history': { title: 'Conversation History', subtitle: 'Review your past conversations' },
            'settings': { title: 'Settings', subtitle: 'Customize your Varta experience' }
        };
        elements.pageTitle.textContent = pageInfo[state.currentPage].title;
        elements.pageSubtitle.textContent = pageInfo[state.currentPage].subtitle;
        elements.dashboardPages.forEach(page => page.classList.toggle('hidden', page.id !== `${state.currentPage}-page`));
        elements.dashboardItems.forEach(item => item.classList.toggle('active-dashboard-item', item.dataset.page === state.currentPage));
        
        // Update specific page content when active
        if (state.currentPage === 'settings') {
            updateSettingsForm();
        } else if (state.currentPage === 'quick-responses') {
            renderQuickResponsesGrid();
        } else if (state.currentPage === 'emergency') {
            renderEmergencyContacts();
        } else if (state.currentPage === 'history') {
            renderConversationHistory();
        }
    }

    function renderMessages() {
        if (state.messages.length === 0) {
            elements.messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 py-10">
                    <i class="fas fa-comments text-5xl mb-4 text-gray-300"></i>
                    <p class="text-xl">Start a conversation by typing or using voice</p>
                    <p class="text-gray-400 mt-2">Your messages will be translated in real-time</p>
                </div>`;
            return;
        }
        
        elements.messagesContainer.innerHTML = state.messages.map(msg => {
            const isUser = msg.speaker === 'You';
            const bgColor = isUser ? 'bg-primary-500 text-white' : 'bg-gray-100 text-gray-800';
            const justify = isUser ? 'justify-end' : 'justify-start';
            const speakerColor = isUser ? 'text-primary-100' : 'text-gray-600';
            const timeColor = isUser ? 'text-primary-200' : 'text-gray-500';
            const borderColor = isUser ? 'border-primary-400' : 'border-gray-300';
            
            return `
            <div class="fade-in mb-4 flex ${justify}">
                <div class="max-w-[80%] ${bgColor} rounded-2xl px-4 py-3 shadow-sm message-hover transition-all">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-medium text-sm ${speakerColor}">${msg.speaker}</span>
                        <span class="text-xs ${timeColor}">${formatTime(msg.timestamp)}</span>
                    </div>
                    <p class="text-lg">${msg.message}</p>
                    ${msg.translatedMessage && state.settings.showOriginal ? `
                        <div class="mt-2 pt-2 border-t ${borderColor}">
                            <p class="text-sm opacity-90">${msg.translatedMessage}</p>
                            ${msg.sourceLanguage ? `<p class="text-xs opacity-70 mt-1">Detected: ${languageMap[msg.sourceLanguage] || msg.sourceLanguage}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>`;
        }).join('');
        
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
    }

    function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50 fade-in';
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-400 mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // ============================
    // EVENT LISTENERS & INIT
    // ============================

    function setupEventListeners() {
        // Conversation event listeners
        elements.sendText.addEventListener('click', sendTextMessage);
        elements.textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage();
            }
        });
        
        elements.toggleListening.addEventListener('click', toggleListening);
        elements.toggleAudio.addEventListener('click', toggleAudio);
        elements.toggleQuickResponses.addEventListener('click', toggleQuickResponses);
        elements.closeQuickResponses.addEventListener('click', toggleQuickResponses);
        
        // Speaker button event listener
        elements.speakerBtn.addEventListener('click', async () => {
            if (state.messages.length > 0) {
                const lastMessage = state.messages[state.messages.length - 1];
                const textToSpeak = lastMessage.speaker === "You" ? lastMessage.translatedMessage : lastMessage.message;
                const langToSpeak = lastMessage.speaker === "You" ? state.targetLanguage : (lastMessage.sourceLanguage || state.sourceLanguage);
                await textToSpeech(textToSpeak, langToSpeak);
                showNotification('Replaying last message');
            } else {
                showNotification('No messages to replay');
            }
        });
        
        // Navigation event listeners
        elements.dashboardItems.forEach(item => {
            item.addEventListener('click', () => {
                state.currentPage = item.dataset.page;
                updatePageUI();
            });
        });
        
        // Language selection event listeners
        elements.sourceLanguage.addEventListener('change', (e) => {
            state.sourceLanguage = e.target.value;
            state.settings.sourceLanguage = e.target.value;
            updateTranslationUI();
            if (recognition) {
                recognition.lang = languageCodeMap[state.sourceLanguage];
                if (state.isListening) {
                    recognition.stop();
                }
            }
        });
        
        elements.targetLanguage.addEventListener('change', (e) => {
            state.targetLanguage = e.target.value;
            state.settings.targetLanguage = e.target.value;
            updateTranslationUI();
        });
        
        // Logout event listeners
        elements.logoutBtn.addEventListener('click', () => {
            elements.logoutModal.classList.remove('hidden');
        });

        elements.cancelLogout.addEventListener('click', () => {
            elements.logoutModal.classList.add('hidden');
        });

        elements.confirmLogout.addEventListener('click', () => {
            // Clear user data from storage
            localStorage.removeItem('userData');
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('userData');
            sessionStorage.removeItem('authToken');
            
            // Redirect to login
            window.location.href = '/logout/';
        });
        
        // Setup specialized event listeners
        setupProfileEventListeners();
        setupSettingsEventListeners();
        setupQuickResponsesEventListeners();
        setupEmergencyContactsEventListeners();
        setupHistoryEventListeners();
    }

    // Profile Functions
    function updateUserProfile() {
        if (state.user && state.user.name) {
            elements.userName.textContent = state.user.name;
            elements.userInitials.textContent = getInitials(state.user.name);
            elements.profileName.value = state.user.name;
            elements.profileEmail.value = state.user.email;
        }
    }

    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase();
    }

    function setupProfileEventListeners() {
        // Update profile
        elements.updateProfile.addEventListener('click', () => {
            const newName = elements.profileName.value.trim();
            const newEmail = elements.profileEmail.value.trim();
            
            if (!newName) {
                alert('Please enter a valid name');
                return;
            }
            
            state.user.name = newName;
            state.user.email = newEmail;
            updateUserProfile();
            showNotification('Profile updated successfully');
        });
    }

    // Settings Functions
    function updateSettingsForm() {
        // Set form values based on current state
        elements.settingsAutoSpeak.checked = state.settings.autoSpeak;
        elements.settingsSpeechRate.value = state.settings.speechRate;
        elements.speechRateValue.textContent = state.settings.speechRate.toFixed(1);
        elements.settingsShowOriginal.checked = state.settings.showOriginal;
        elements.settingsFontSize.value = state.settings.fontSize;
        elements.settingsMessageAlerts.checked = state.settings.messageAlerts;
        elements.settingsSpeechAlerts.checked = state.settings.speechAlerts;
        elements.settingsSourceLanguage.value = state.settings.sourceLanguage;
        elements.settingsTargetLanguage.value = state.settings.targetLanguage;
    }

    function setupSettingsEventListeners() {
        // Auto speak toggle
        elements.settingsAutoSpeak.addEventListener('change', (e) => {
            state.settings.autoSpeak = e.target.checked;
            state.speakingEnabled = e.target.checked;
            updateAudioUI();
        });

        // Speech rate
        elements.settingsSpeechRate.addEventListener('input', (e) => {
            state.settings.speechRate = parseFloat(e.target.value);
            state.user.accessibility_settings.speech_rate = parseFloat(e.target.value);
            elements.speechRateValue.textContent = state.settings.speechRate.toFixed(1);
        });

        // Show original text
        elements.settingsShowOriginal.addEventListener('change', (e) => {
            state.settings.showOriginal = e.target.checked;
            renderMessages();
        });

        // Font size
        elements.settingsFontSize.addEventListener('change', (e) => {
            state.settings.fontSize = e.target.value;
            // Apply font size changes to the UI
            document.querySelectorAll('.dashboard-page p, .dashboard-page span').forEach(el => {
                el.classList.remove('text-sm','text-base','text-lg');
                el.classList.add(state.settings.fontSize);
            });
        });

        // Message alerts
        elements.settingsMessageAlerts.addEventListener('change', (e) => {
            state.settings.messageAlerts = e.target.checked;
            if (state.settings.messageAlerts) {
                showNotification('Message alerts enabled');
            }
        });

        // Speech alerts
        elements.settingsSpeechAlerts.addEventListener('change', (e) => {
            state.settings.speechAlerts = e.target.checked;
            if (state.settings.speechAlerts) {
                showNotification('Speech alerts enabled');
            }
        });

        // Source language in settings
        elements.settingsSourceLanguage.addEventListener('change', (e) => {
            state.settings.sourceLanguage = e.target.value;
            // Update main app source language
            state.sourceLanguage = e.target.value;
            updateTranslationUI();
            if (recognition) {
                recognition.lang = languageCodeMap[state.sourceLanguage];
                if (state.isListening) {
                    recognition.stop();
                }
            }
        });

        // Target language in settings
        elements.settingsTargetLanguage.addEventListener('change', (e) => {
            state.settings.targetLanguage = e.target.value;
            // Update main app target language
            state.targetLanguage = e.target.value;
            updateTranslationUI();
        });

        // Clear history
        elements.settingsClearHistory.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
                state.messages = [];
                state.conversationHistory = [];
                renderMessages();
                renderConversationHistory();
                showNotification('Chat history cleared');
            }
        });

        // Export data
        elements.exportData.addEventListener('click', () => {
            const data = {
                messages: state.messages,
                quickResponses: state.quickResponses,
                emergencyContacts: state.emergencyContacts,
                conversationHistory: state.conversationHistory,
                settings: state.settings,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `varta-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully');
        });
    }

    // Quick Responses Functions
    function renderQuickResponsesGrid() {
        if (state.quickResponses.length === 0) {
            elements.quickResponsesGrid.innerHTML = `
                <div class="col-span-full text-center py-10">
                    <i class="fas fa-reply text-5xl mb-4 text-gray-300"></i>
                    <p class="text-xl text-gray-500">No quick responses yet</p>
                    <p class="text-gray-400 mt-2">Add your first quick response to get started</p>
                </div>`;
            return;
        }
        
        // Group responses by category
        const responsesByCategory = {};
        state.quickResponses.forEach(response => {
            if (!responsesByCategory[response.category]) {
                responsesByCategory[response.category] = [];
            }
            responsesByCategory[response.category].push(response);
        });
        
        let html = '';
        Object.keys(responsesByCategory).forEach(category => {
            html += `<div class="col-span-full">
                <h3 class="font-semibold text-gray-800 mb-3">${category}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">`;
            
            responsesByCategory[category].forEach(response => {
                html += `
                <div class="bg-white border border-gray-200 rounded-xl p-4 cursor-pointer transition-all hover:shadow-md quick-response-item" data-id="${response.id}">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-gray-800 flex-1">${response.text}</p>
                        <button class="text-gray-400 hover:text-red-500 delete-response ml-2" data-id="${response.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>Used ${response.frequency_used} times</span>
                        <button class="text-primary-500 hover:text-primary-700 use-response" data-id="${response.id}">
                            Use <i class="fas fa-paper-plane ml-1"></i>
                        </button>
                    </div>
                </div>`;
            });
            
            html += `</div></div>`;
        });
        
        elements.quickResponsesGrid.innerHTML = html;
    }

    function renderQuickResponsesList() {
        if (state.quickResponses.length === 0) {
            elements.quickResponsesList.innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-reply text-3xl mb-4 text-gray-300"></i>
                    <p class="text-gray-500">No quick responses yet</p>
                </div>`;
            return;
        }
        
        const renderHTML = (response) => `
            <div class="bg-white border border-gray-200 rounded-xl p-3 cursor-pointer transition-all hover:shadow-md mb-2 quick-response" data-id="${response.id}">
                <div class="flex justify-between items-start">
                    <p class="text-gray-800 text-sm flex-1">${response.text}</p>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full ml-2">${response.category}</span>
                </div>
            </div>`;
        elements.quickResponsesList.innerHTML = state.quickResponses.map(renderHTML).join('');
    }

    function setupQuickResponsesEventListeners() {
        // Add quick response
        elements.addQuickResponse.addEventListener('click', () => {
            elements.addResponseModal.classList.remove('hidden');
        });

        // Cancel add response
        elements.cancelAddResponse.addEventListener('click', () => {
            elements.addResponseModal.classList.add('hidden');
            elements.newResponseText.value = '';
            elements.newResponseCategory.value = 'Greetings';
        });

        // Save response
        elements.saveResponse.addEventListener('click', () => {
            const text = elements.newResponseText.value.trim();
            const category = elements.newResponseCategory.value;
            
            if (!text) {
                alert('Please enter a response text');
                return;
            }
            
            const newResponse = {
                id: Date.now(),
                text: text,
                category: category,
                frequency_used: 0
            };
            
            state.quickResponses.push(newResponse);
            renderQuickResponsesGrid();
            renderQuickResponsesList();
            elements.addResponseModal.classList.add('hidden');
            elements.newResponseText.value = '';
            elements.newResponseCategory.value = 'Greetings';
            
            showNotification('Quick response added successfully');
        });

        // Use quick response from grid
        elements.quickResponsesGrid.addEventListener('click', (e) => {
            const useBtn = e.target.closest('.use-response');
            if (useBtn) {
                const id = parseInt(useBtn.dataset.id);
                const response = state.quickResponses.find(r => r.id === id);
                if (response) {
                    // Update frequency
                    response.frequency_used += 1;
                    
                    // Add to conversation
                    addMessage({
                        speaker: "You", 
                        message: response.text, 
                        type: "quick_response",
                        timestamp: new Date().toISOString()
                    });
                    
                    // If on quick responses page, update the display
                    if (state.currentPage === 'quick-responses') {
                        renderQuickResponsesGrid();
                    }
                    
                    showNotification('Quick response sent');
                }
            }
            
            // Delete quick response
            const deleteBtn = e.target.closest('.delete-response');
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                if (confirm('Are you sure you want to delete this quick response?')) {
                    state.quickResponses = state.quickResponses.filter(r => r.id !== id);
                    renderQuickResponsesGrid();
                    renderQuickResponsesList();
                    showNotification('Quick response deleted');
                }
            }
        });

        // Use quick response from panel
        elements.quickResponsesList.addEventListener('click', (e) => {
            const quickResponseEl = e.target.closest('.quick-response');
            if (quickResponseEl) {
                const id = parseInt(quickResponseEl.dataset.id);
                const response = state.quickResponses.find(r => r.id === id);
                if (response) {
                    // Update frequency
                    response.frequency_used += 1;
                    
                    addMessage({
                        speaker: "You", 
                        message: response.text, 
                        type: "quick_response",
                        timestamp: new Date().toISOString()
                    });
                    toggleQuickResponses();
                    
                    showNotification('Quick response sent');
                }
            }
        });
    }

    // Emergency Contacts Functions
    function renderEmergencyContacts() {
        if (state.emergencyContacts.length === 0) {
            elements.emergencyContactsList.innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-ambulance text-5xl mb-4 text-gray-300"></i>
                    <p class="text-xl text-gray-500">No emergency contacts yet</p>
                    <p class="text-gray-400 mt-2">Add your first emergency contact to get started</p>
                </div>`;
            return;
        }
        
        // Group contacts by type
        const contactsByType = {};
        state.emergencyContacts.forEach(contact => {
            if (!contactsByType[contact.type]) {
                contactsByType[contact.type] = [];
            }
            contactsByType[contact.type].push(contact);
        });
        
        let html = '';
        Object.keys(contactsByType).forEach(type => {
            html += `<div class="mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">${type}</h3>
                <div class="space-y-3">`;
            
            contactsByType[type].forEach(contact => {
                let bgColor = 'bg-red-50';
                let borderColor = 'border-red-200';
                let textColor = 'text-red-800';
                
                if (type === 'Medical') {
                    bgColor = 'bg-blue-50';
                    borderColor = 'border-blue-200';
                    textColor = 'text-blue-800';
                } else if (type === 'Police') {
                    bgColor = 'bg-indigo-50';
                    borderColor = 'border-indigo-200';
                    textColor = 'text-indigo-800';
                } else if (type === 'Fire Department') {
                    bgColor = 'bg-orange-50';
                    borderColor = 'border-orange-200';
                    textColor = 'text-orange-800';
                } else if (type === 'Personal') {
                    bgColor = 'bg-green-50';
                    borderColor = 'border-green-200';
                    textColor = 'text-green-800';
                }
                
                html += `
                <div class="${bgColor} border ${borderColor} rounded-xl p-4 emergency-contact" data-id="${contact.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas ${getContactIcon(contact.type)} ${textColor} text-xl mr-3"></i>
                            <div>
                                <h3 class="font-bold ${textColor}">${contact.name}</h3>
                                <p class="${textColor}">${contact.phone}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="text-gray-400 hover:text-primary-500 call-contact" data-phone="${contact.phone}">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="text-gray-400 hover:text-red-500 delete-contact" data-id="${contact.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            html += `</div></div>`;
        });
        
        elements.emergencyContactsList.innerHTML = html;
    }

    function getContactIcon(type) {
        switch(type) {
            case 'Emergency Services': return 'fa-ambulance';
            case 'Medical': return 'fa-hospital';
            case 'Police': return 'fa-shield-alt';
            case 'Fire Department': return 'fa-fire-extinguisher';
            case 'Personal': return 'fa-user';
            default: return 'fa-phone';
        }
    }

    function setupEmergencyContactsEventListeners() {
        // Add emergency contact
        elements.addEmergencyContact.addEventListener('click', () => {
            elements.addContactModal.classList.remove('hidden');
        });

        // Cancel add contact
        elements.cancelAddContact.addEventListener('click', () => {
            elements.addContactModal.classList.add('hidden');
            elements.newContactName.value = '';
            elements.newContactPhone.value = '';
            elements.newContactType.value = 'Emergency Services';
        });

        // Save contact
        elements.saveContact.addEventListener('click', () => {
            const name = elements.newContactName.value.trim();
            const phone = elements.newContactPhone.value.trim();
            const type = elements.newContactType.value;
            
            if (!name || !phone) {
                alert('Please fill in all fields');
                return;
            }
            
            const newContact = {
                id: Date.now(),
                name: name,
                phone: phone,
                type: type
            };
            
            state.emergencyContacts.push(newContact);
            renderEmergencyContacts();
            elements.addContactModal.classList.add('hidden');
            elements.newContactName.value = '';
            elements.newContactPhone.value = '';
            elements.newContactType.value = 'Emergency Services';
            
            showNotification('Emergency contact added successfully');
        });

        // Emergency contacts actions
        elements.emergencyContactsList.addEventListener('click', (e) => {
            // Call contact
            const callBtn = e.target.closest('.call-contact');
            if (callBtn) {
                const phone = callBtn.dataset.phone;
                if (confirm(`Call ${phone}?`)) {
                    // In a real app, this would initiate a phone call
                    showNotification(`Calling ${phone}...`);
                    // Simulate call
                    setTimeout(() => {
                        showNotification(`Call to ${phone} completed`);
                    }, 2000);
                }
            }
            
            // Delete contact
            const deleteBtn = e.target.closest('.delete-contact');
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                if (confirm('Are you sure you want to delete this emergency contact?')) {
                    state.emergencyContacts = state.emergencyContacts.filter(c => c.id !== id);
                    renderEmergencyContacts();
                    showNotification('Emergency contact deleted');
                }
            }
        });
    }

    // History Functions
    function renderConversationHistory() {
        if (state.conversationHistory.length === 0) {
            elements.conversationHistoryList.innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-history text-5xl mb-4 text-gray-300"></i>
                    <p class="text-xl text-gray-500">No conversation history yet</p>
                    <p class="text-gray-400 mt-2">Start a conversation to see it here</p>
                </div>`;
            return;
        }
        
        let html = '';
        state.conversationHistory.forEach(conversation => {
            html += `
            <div class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition cursor-pointer conversation-history-item" data-id="${conversation.id}">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center text-white font-semibold mr-3">
                            ${conversation.contact.split(' ').map(n => n[0]).join('').toUpperCase()}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-800">${conversation.contact}</h3>
                            <p class="text-gray-600 text-sm">${conversation.languagePair} • ${conversation.messageCount} messages</p>
                        </div>
                    </div>
                    <span class="text-gray-500 text-sm">${conversation.timestamp}</span>
                </div>
                <p class="text-gray-700">${conversation.lastMessage}</p>
                <div class="flex justify-end gap-2 mt-3">
                    <button class="text-primary-500 hover:text-primary-700 view-conversation" data-id="${conversation.id}">
                        <i class="fas fa-eye mr-1"></i> View
                    </button>
                    <button class="text-red-500 hover:text-red-700 delete-conversation" data-id="${conversation.id}">
                        <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                </div>
            </div>`;
        });
        
        elements.conversationHistoryList.innerHTML = html;
    }

    function setupHistoryEventListeners() {
        // Filter history
        elements.filterHistory.addEventListener('click', () => {
            showNotification('Filter functionality would be implemented here');
        });

        // Search history
        elements.searchHistory.addEventListener('click', () => {
            const searchTerm = prompt('Enter search term:');
            if (searchTerm) {
                showNotification(`Searching for: ${searchTerm}`);
                // In a real app, this would filter the conversation history
            }
        });

        // History item actions
        elements.conversationHistoryList.addEventListener('click', (e) => {
            // View conversation
            const viewBtn = e.target.closest('.view-conversation');
            if (viewBtn) {
                const id = parseInt(viewBtn.dataset.id);
                showNotification(`Viewing conversation ${id}`);
                // In a real app, this would load the conversation
            }
            
            // Delete conversation
            const deleteBtn = e.target.closest('.delete-conversation');
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                if (confirm('Are you sure you want to delete this conversation?')) {
                    state.conversationHistory = state.conversationHistory.filter(c => c.id !== id);
                    renderConversationHistory();
                    showNotification('Conversation deleted');
                }
            }
        });
    }

    // Initialize the application
    function init() {
        // Load user data first
        updateUserProfile();
        
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => {
                // Pre-load voices to ensure they are available
                window.speechSynthesis.getVoices();
            };
        }
        
        initializeSpeechRecognition();
        setupEventListeners();
        renderQuickResponsesList();
        renderQuickResponsesGrid();
        renderEmergencyContacts();
        renderConversationHistory();
        updateListeningUI();
        updateAudioUI();
        updatePageUI();
        updateTranslationUI();
        
        // Show welcome notification
        setTimeout(() => {
            showNotification(`Welcome to Varta, ${state.user.name}! Real-time speech translation is ready.`);
        }, 1000);
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>